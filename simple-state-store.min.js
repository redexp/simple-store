!function(root,factory){"function"==typeof define&&define.amd?define(["simple-diff"],factory):"object"==typeof exports?module.exports=factory(require("simple-diff")):root.SimpleStore=factory(root.simpleDiff)}(this,function(diff){function SimpleStore(state,options){this.state=state||{},this.options=options||{},this.events={}}function isString(value){return"string"==typeof value}function isObject(value){return!!value&&"object"==typeof value}function stringToPath(str){return str?str.split("."):[]}function absolutePath(state,path){path=[].concat(path);for(var prop,i=0,len=path.length;i<=len;i++)if(prop=path[i],isObject(prop))path[i]=prop=findIndex(state,prop);else{if(!has(state,prop))return path;state=state[prop]}return path}function extend(target){for(var i=1,len=arguments.length;i<len;i++){var source=arguments[i];for(var prop in source)has(source,prop)&&(target[prop]=source[prop])}return target}function has(obj,prop){return!!obj&&obj.hasOwnProperty(prop)}function findIndex(array,props,fullEqual){for(var item,i=0,len=array.length;i<len;i++)if(item=array[i],isEqual(item,props,fullEqual))return i;return-1}function findRuleIndex(rules,props){for(var i=0,len=rules.length;i<len;i++)if(isEqual(rules[i][0],props,!0))return i;return-1}function isEqual(item,props,fullEqual){if(item===props)return!0;var prop;for(prop in props)if(has(props,prop)&&item[prop]!==props[prop])return!1;if(fullEqual)for(prop in item)if(has(item,prop)&&item[prop]!==props[prop])return!1;return!0}function removeItem(array,item){for(var index;(index=array.indexOf(item))>-1;)array.splice(index,1)}SimpleStore.prototype.set=function(path,newState){1===arguments.length&&(newState=path,path=[]),isString(path)&&(path=stringToPath(path)),path=absolutePath(this.state,path);var parent=this.get(path.slice(0,path.length-1)),oldState=this.get(path);if(0===path.length)oldState=this.state,this.state=newState;else{var last=path[path.length-1];parent=this.get(path.slice(0,path.length-1)),oldState=parent[last],parent[last]=newState}var store=this;return diff(oldState,newState,extend({},this.options,{oldPath:path,newPath:path,callback:function(e){store.trigger(e)}})),this},SimpleStore.prototype.get=function(path,index){isString(path)&&(path=stringToPath(path)),1===arguments.length&&(index=path.length-1);for(var prop,curState=this.state,i=0;i<=index;i++){if(prop=path[i],isObject(prop)&&(prop=findIndex(curState,prop)),!has(curState,prop))return;curState=curState[prop]}return curState};var EVENTS="__events__",RULES="__rules__";return SimpleStore.prototype.on=function(events,path,callback){events=events.split(/\s+/),isString(path)&&(path=stringToPath(path));for(var event,i=0,len=events.length;i<len;i++){event=events[i];var ev=this.events;ev[event]||(ev[event]={}),ev=ev[event];for(var item,j=0,n=path.length;j<n;j++)if(item=path[j],isObject(item)){var rules=ev[RULES];rules||(ev[RULES]=rules=[]);var ruleIndex=findRuleIndex(rules,item);ruleIndex>-1?ev=rules[ruleIndex][1]:rules.push([item,ev={}])}else ev[item]||(ev[item]={}),ev=ev[item];ev[EVENTS]||(ev[EVENTS]=[]),ev[EVENTS].push(callback)}return this},SimpleStore.prototype.off=function(events,path,callback){if(0===arguments.length)return this.events={},this;var event;if(isObject(events)){for(event in this.events)this.off(event,events,path);return this}events=events.split(/\s+/),isString(path)&&(path=stringToPath(path));events:for(var i=0,len=events.length;i<len;i++){event=events[i];var ev=this.events;if(ev[event])if(path){ev=ev[event];for(var item,j=0,n=path.length;j<n;j++)if(item=path[j],isObject(item)){var rules=ev[RULES];if(!rules)continue events;var ruleIndex=findRuleIndex(rules,item);if(!(ruleIndex>-1))continue events;ev=rules[ruleIndex][1]}else{if(!ev[item])continue events;ev=ev[item]}ev[EVENTS]&&(callback?removeItem(ev[EVENTS],callback):ev[EVENTS]=[])}else ev[event]={}}return this},SimpleStore.prototype.trigger=function(event,path){function trigger(events,path,index){if(index===path.length&&has(events,EVENTS))for(var cb,i=0,len=events[EVENTS].length;i<len;i++)cb=events[EVENTS][i],cb.apply(store,args);else{events[path[index]]&&trigger(events[path[index]],path,index+1),events["*"]&&trigger(events["*"],path,index+1);var rules=events[RULES];if(rules){var obj=store.get(path,index);if(!obj)return;for(var rI=0,rLen=rules.length;rI<rLen;rI++)if(isEqual(obj,rules[rI][0])){trigger(rules[rI][1],path,index+1);break}}}}var args;if(isObject(event)?(args=Array.prototype.slice.call(arguments),event=args[0].type,path=args[0].path||args[0].newPath):args=Array.prototype.slice.call(arguments,2),!this.events[event])return this;isString(path)&&(path=stringToPath(path));var store=this;return trigger(this.events[event],path,0),this},SimpleStore.prototype.getItem=function(path,props){var array=this.get(path),index=findIndex(array,props);return array[index]},SimpleStore.prototype.getIndex=function(path,props){return findIndex(this.get(path),props)},SimpleStore.prototype.addItem=function(path,item,index){isString(path)&&(path=stringToPath(path));var newArray=[].concat(this.get(path));return 2===arguments.length?newArray.push(item):newArray.splice(index,0,item),this.set(path,newArray),this},SimpleStore.prototype.removeItem=function(path,index){isString(path)&&(path=stringToPath(path));var newArray=[].concat(this.get(path));return isObject(index)&&(index=findIndex(newArray,index)),newArray.splice(index,1),this.set(path,newArray),this},SimpleStore.prototype.moveItem=function(path,from,to){isString(path)&&(path=stringToPath(path));var array=this.get(path);if(isObject(from)&&(from=findIndex(array,from),from===-1))throw new Error("Object not found in "+path.join("."));if(from>=array.length&&(from=array.length-1),to>=array.length&&(to=array.length-1),from===to)return this;var newArray=[].concat(array),item=newArray[from];return newArray.splice(from,1),newArray.splice(to,0,item),this.set(path,newArray),this},SimpleStore});